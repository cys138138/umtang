!function(e){var t={setUrlByFileInput:function(e,t){if(e&&t&&t[0]&&FileReader){var a=e.files&&e.files[0];if(a){var o=new FileReader;o.onload=function(e){t.attr("src",e.target.result)},o.readAsDataURL(a)}}},uploadFile:function(e,a,o,n,s){var r,i,l;return e&&("INPUT"==e.tagName&&(e=e.files[0]),r=e.name.split("."),i=r[0],l=r[1]),!!(FormData&&e&&i&&l)&&void ajax({url:UeData.aUrl.uploadInfoUrl,data:{isPrivate:n,fileName:s?i:null,postfix:l},unblock:!0,success:function(n){if(1!=n.status)return void a(n);var s=n.data,r=e.size;r<20971520?t.uploadFileAction(s.imgUrl,e,a,o,s.sign,s.id):t.sliceUploadFileHandle(s.imgUrl,e,a,o,s.sign,s.id)}})},uploadFileHandle:function(a,o,n,s){var r=o.name;if(new RegExp("\\.gif").test(o.name))return void t.uploadFileAction(a,o,n,s);var i=new FileReader;i.onloadend=function(){if(this.error)alert(this.error);else{var o=new Image;o.src=this.result,e.Tools.resizeImage(o,750,1334,function(o){t.uploadFileAction(a,e.Tools.parseToFile(o,r),n,s)})}},i.readAsDataURL(o)},uploadFileAction:function(e,a,o,n,s,r){if(e&&a&&o){var i=new FormData,l=new XMLHttpRequest;l.open("post",e,!0),s&&r?(l.setRequestHeader("timeout","60"),l.setRequestHeader("Authorization",s),i.append("op","upload")):i.append("_csrf",$('meta[name="csrf-token"]').attr("content")),l.setRequestHeader("x-requested-with","XMLHttpRequest"),l.upload.addEventListener("progress",function(e){if(e.lengthComputable&&n){var t=e.loaded/e.total*100|0;n(t)}}),l.addEventListener("load",function(e){var i=JSON.parse(e.target.response);s&&r?t.uploadSuccessHandle(a,i,r,o,n):o(i)}),i.append("filecontent",a),l.send(i)}},sliceUploadFileHandle:function(e,a,o,n,s,r){function i(){d=new FormData,d.append("op","upload_slice"),d.append("session",u),d.append("offset",p),d.append("fileContent",f.call(a,p,p+c)),l(d,function(e){var s=JSON.parse(e.target.response),l=s.data;0==s.code&&l.hasOwnProperty("offset")?(p=l.offset+=c,i()):l&&l.access_url&&t.uploadSuccessHandle(a,s,r,o,n)})}function l(t,a){var o=new XMLHttpRequest;o.open("post",e,!0),o.setRequestHeader("timeout","60"),o.setRequestHeader("Authorization",s),o.setRequestHeader("x-requested-with","XMLHttpRequest"),o.addEventListener("progress",function(e){if(e.lengthComputable&&n){var t=(p+e.loaded)/g*100|0;n(t)}}),o.addEventListener("load",a),o.send(t)}var d,u,p,c,f=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,v=new FileReader,g=a.size;v.onload=function(e){d=new FormData,d.append("op","upload_slice"),d.append("sha",CryptoJS.SHA1(CryptoJS.lib.WordArray.create(e.target.result)).toString()),d.append("filesize",a.size),l(d,function(e){var s,l=JSON.parse(e.target.response);0==l.code?(s=l.data,u=s.session,p=s.offset,c=s.slice_size,s&&s.access_url?t.uploadSuccessHandle(a,l,r,o,n):i()):o({msg:l.message,status:0==l.code?1:0})})},v.readAsArrayBuffer(a),n("文件上传准备中...")},uploadSuccessHandle:function(e,t,a,o,n){var s=new FileReader;s.onload=function(e){o({msg:0==t.code?"上传成功":"上传失败",status:0==t.code?1:0,url:e.target.result,id:a})},s.readAsDataURL(e),n&&n("提交成功，正在生成预览...")}};e.Tools=$.extend(e.Tools,t)}(window);