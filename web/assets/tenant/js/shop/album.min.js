window.Album=window.PageBase.init(function(){function e(e,a){e.toggleClass("hide",0==a.length),PageBase.cloneItem(e,a.length,!0,!0).each(function(e){var i=$(this),t=a[e];i.data({id:t.id,resourceId:t.resource_id}).toggleClass("is-cover",1==t.is_cover).toggleClass("is-pending",0==t.id),i.find("img").replaceWith(Ui.buildImage(t.path||t.resource_path))})}function a(e,a,i){a.data("resourceId",i),a.removeClass("is-cover").removeClass("hide").addClass("is-pending"),Tools.setUrlByFileInput(e,a.find("img"))}var i={listCache:[]};this.initPage=function(){var t=this,o=t.getConfig("selector"),d=t.getTemplate(),n=$(d),s=t.getConfig("goodsId");s?(n.find(".J-goods-tap").removeClass("hide"),n.find(".J-info").attr("href",t.getConfig("editUrl"))):n.find(".J-shop-tap").removeClass("hide");var r=UmtPageNum.build();r.bind(UmtPageNum.EVENT_PAGE_CHANGE,function(a,o){var d=n.find(".J-item");if(i.listCache[o])return UmtPageNum.update(r,o),void e(d,i.listCache[o]);var l=9;ajax({url:t.getConfig("listUrl"),data:{page:o,pageSize:l,goodsId:s}}).done(function(a){var t=a.data.totalCount||a.data.count,n=Math.ceil(t/l);i.listCache[o]=a.data.aList||a.data.list,UmtPageNum.update(r,o,n),e(d,i.listCache[o])})}),n.find(".J-page-num").append(r);var l=t.getConfig("addUrl");n.find(".J-file").on("change",function(){var e,i=this,o=!1,d=n.find(".J-item").first();d.hasClass("hide")?(o=!0,e=d.removeClass("hide")):(e=d.clone(!0),e.removeData(),d.before(e)),Tools.uploadFileHandle(t.getConfig("uploadUrl"),this.files[0],function(t){var d=t.data.resource_id;return e.removeClass("on-upload").find(".J-label").text("审核中..."),1!=t.status?void UNotice.show(t.msg,t.status,function(){o?location.reload():e.remove()}):void(l?ajax({url:l,data:{goodsId:s,resourceId:d}}).done(function(){a(i,e,d)}):a(i,e,d))},function(a){e.addClass("on-upload").find(".J-label").text("上传进度:"+a+"%")}),this.value=""}),n.find(".J-set").click(function(){var e=$(this).parents(".J-item");ajax({url:t.getConfig("setUrl"),data:{id:e.data("id"),goodsId:s,resourceId:e.data("resourceId"),action:s&&1}}).done(function(a){UNotice.show(a.msg,a.status),e.addClass("is-cover").siblings().removeClass("is-cover")})}),n.find(".J-del").click(function(){var e=$(this).parents(".J-item");UNotice.confirm("确认删除","是否删除图片?",-1,function(){ajax({url:t.getConfig("delUrl"),data:{id:e.data("id"),goodsId:s,resourceId:e.data("resourceId"),action:s&&2}}).done(function(a){1==a.status&&(0==e.siblings().length?location.reload():e.remove())})})}),$(o).append(n),r.triggerHandler(UmtPageNum.EVENT_PAGE_CHANGE,1)}});