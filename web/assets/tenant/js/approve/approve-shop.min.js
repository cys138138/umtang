window.ApproveShop=PageBase.init(function(){this.initPage=function(){function t(t){var e=f.clone(!0);e.find("input").remove(),e.find(".J-progress").remove(),e.find("img").replaceWith(Ui.buildImage(t.path)),e.data("data",t).addClass("pic-id"),f.before(e),t.reason&&e.find(".J-pic-error").show().html(t.reason)}function e(e){function i(t,e){return e.reason&&d.find(".J-"+t+"-error").html(e.reason).show(),d.find("[name="+t+"]").val(e.value)}var o,r;if(!e.name)return!1;if(i("name",e.name),e.profile.path&&i("profile",e.profile).siblings("img").replaceWith(Ui.buildImage(e.profile.path)),i("contact_number",e.contact_number),i("description",e.description),e.photo){var l=e.photo;for(o=0,r=l.length;o<r;o++)t(l[o])}var c={address:e.address.value,location:{lng:e.lng.value,lat:e.lat.value},adcode:a.getConfig("adcode")};n=UmtMapSelector.build(c),$("#map").append(n),n.find(".J-location-btn").attr("type","button");var f=d.find(".J-type-list"),p=f.find(".J-type-item").remove();for(o=0,r=s.length;o<r;o++){var u=p.clone();u.find("input").val(s[o].id),u.find("span").html(s[o].name),f.append(u)}if(e.commercial_tenant_type){var h=e.commercial_tenant_type.value;for(o=0,r=h.length;o<r;o++)f.find("[type=checkbox][value="+h[o]+"]").attr("checked",!0);e.commercial_tenant_type.reason&&d.find(".J-commercial_tenant_type-error").html(e.commercial_tenant_type.reason).show()}}function i(t){function e(t){var e=d.find("[name="+t+"]").focus();return UNotice.show(e[0].title+" 格式不正确",-1),e}if(0==t.is_draft){if(t.name.length<=1)return e("name"),!1;if(t.profile.length<1)return e("profile"),!1;if(t.contact_number.length<1)return e("contact_number"),!1;if(t.description.length<1||t.description.length>100)return e("description"),!1;if(d.find(".J-pic-item").length<=1)return UNotice.show("至少一张商铺照片",-1),!1;if(!t.commercial_tenant_type.length)return UNotice.show("至少选择一个商铺类型",-1),!1;var i=UmtMapSelector.parseData(n);if(!i.address)return UNotice.show("请填写具体地址",-1),!1}return!0}var n,a=this,o=a.getConfig("selector"),r=a.getConfig("template"),l=a.getConfig("phpData"),s=a.getConfig("commercialTenantTypeList"),c=a.getConfig("url"),d=$(o).append(r),f=d.find(".J-pic-item");d.find(".J-save").on("click",function(){var t=serializeObject(d.find("form")),e=$(this);if(t.is_draft=e.data("type"),i(t)){var a=UmtMapSelector.parseData(n);t.lng=a.location.lng,t.lat=a.location.lat,t.address=a.address,ajax({url:c.saveUrl,data:t}).done(function(e){UNotice.show(e.msg,e.status),1==e.status&&0==t.is_draft&&(location.href=c.statusUrl)})}}),d.find(".J-head-pic").on("change",function(){var t=$(this);Tools.uploadFileHandle(c.uploadPicUrl,this.files[0],function(e){return 1!=e.status?(t.val(""),UNotice.show(e.msg,e.status),!1):(t.siblings("img").replaceWith(Ui.buildImage(e.data.path)),void t.siblings("input[type=text]").val(e.data.resource_id))})}),d.find(".J-file-add").on("change",function(){var e=$(this),i=e.siblings(".J-progress").show();Tools.uploadFileHandle(c.uploadShopPicUrl,this.files[0],function(n){0==n.status?(e.val(""),UNotice.show(n.msg,n.status)):t(n.data),i.html("").hide()},function(t){i.html("上传进度:"+t+"%")})}),f.find(".J-del-pic").on("click",function(){var t=$(this).parent(),e=t.data("data");ajax({url:c.delShopPicUrl,data:{resourceId:e.resource_id,id:e.id?e.id:0}}).done(function(e){UNotice.show(e.msg,e.status),1==e.status&&t.remove()})}),e(l)}});